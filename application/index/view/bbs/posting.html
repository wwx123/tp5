<!DOCTYPE html>
<html>
    <head>
       <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<!-- Mobile Devices Support @begin -->
<meta name="referrer" content="always">
<meta content="application/xhtml+xml;charset=UTF-8" http-equiv="Content-Type">
<meta content="no-cache,must-revalidate" http-equiv="Cache-Control">
<meta content="no-cache" http-equiv="pragma">
<meta content="0" http-equiv="expires">
<meta name="referrer" content="always">
<meta content="telephone=no, address=no" name="format-detection">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0" />
<meta name="apple-mobile-web-app-capable" content="yes" /> <!-- apple devices fullscreen -->
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<title>发帖</title>
<link rel="stylesheet" type="text/css" href="css/base.css?_t=20171031">
<script src="js/jweixin-1.2.0.js"></script>
<script src="js/jquery.js?_t=20171020"></script>
<script>
    var g_rem = 20;
    (function (doc, win) {
        var docEl = doc.documentElement,
            resizeEvt = 'orientationchange' in window ? 'orientationchange' : 'resize',
            recalc = function () {
                var clientWidth = docEl.clientWidth;
                if (!clientWidth){
                    clientWidth = 375;
                }
                clientWidth = clientWidth > 640 ? 640 : clientWidth;
                g_rem = 20 * (clientWidth / 375);
                docEl.style.fontSize =  g_rem + 'px';
            };

        if (!doc.addEventListener) return;
        win.addEventListener(resizeEvt, recalc, false);
        doc.addEventListener('DOMContentLoaded', recalc, false);
    })(document, window);
    var _web_base="http://t.flowerplus.cn/".replace(/^https?:/,window.location.protocol);
    document.domain="flowerplus.cn";
</script>
       <link rel="stylesheet" type="text/css" href="css/index.css">
       <style>
            body{background: #fff;}
            textarea{width:100%;height:100%;}
            .inputArea{padding:0.8rem;height:11.25rem;}
            .uploadImgBox{padding: 0.45rem;border-bottom:solid 0.05rem #e5e5e5;}
            .imgBlock{width:3.6rem;height:3.6rem;border-radius: 0.2rem ;margin:0.375rem;border: solid 0.03rem #e9e9e9;}
            .imgWrap{width:100%;height:100%;overflow: hidden;}
            .imgWrap img{height:100%;}
            .submit{padding:2.4rem 0.8rem;}
            .closeBtn{width:0.8rem;height:0.8rem;background-position: -13.2rem 0;right:-0.4rem;top:-0.4rem;}
            #chooseImgBtn img{display: block;width: 2.3rem;margin: 0.85rem auto;}
       </style>
    </head>
    <body>
        <div class="inputArea">
            <textarea id="publish_cont" placeholder="在此输入内容"></textarea>
        </div>
        <div class="uploadImgBox clearfix">
            <!--<div class="imgBlock uploadImgItem fl rlt">
                <div class="imgWrap">
                    <img src="http://osstest.flowerplus.cn/sns_image/20170906/15046816659576.jpg">111
                </div>
                <div class="icon closeBtn abs"></div>
            </div>-->
            <div id="chooseImgBtn" class="imgBlock fl"><img src="images/pic_addbtn.png"></div></div>
        </div>
        <div class="submit"><div id="publishBtn" class="mainButton">发布</div></div>
        <script src="//static2.flowerplus.cn/Static/sns_wx/js/comm.js?_t=201710271711"></script>

<script>
var page_type = '';
var sat = 'cb037e036c03aad3';
var sap = 'default';
var sau = 'https://flowerplus.cloud.sensorsdata.cn:4006/sa?token='+sat+'&project='+sap;

(function(para) {
  var p = para.sdk_url, n = para.name, w = window, d = document, s = 'script',x = null,y = null;
  w['sensorsDataAnalytic201505'] = n;
  w[n] = w[n] || function(a) {return function() {(w[n]._q = w[n]._q || []).push([a, arguments]);}};
  var ifs = ['track','quick','register','registerPage','registerOnce','trackSignup', 'trackAbtest', 'setProfile','setOnceProfile','appendProfile', 'incrementProfile', 'deleteProfile', 'unsetProfile', 'identify','login','logout','trackLink','clearAllRegister','getAppStatus'];
  for (var i = 0; i < ifs.length; i++) {
    w[n][ifs[i]] = w[n].call(null, ifs[i]);
  }
  if (!w[n]._t) {
    x = d.createElement(s), y = d.getElementsByTagName(s)[0];
    x.async = 1;
    x.src = p;
    x.setAttribute('charset','UTF-8');
    y.parentNode.insertBefore(x, y);
    w[n].para = para;
  }
})({
  sdk_url: 'js/sensorsdata.min.js?_t=20171208',
  // heatmap_url: '//static2.flowerplus.cn/Static/js/sa/heatmap.min.js?_t=20171208',
  name: 'sa',
  web_url: 'https://flowerplus.cloud.sensorsdata.cn/',
  server_url: sau,
  heatmap: {
      isTrackLink: false,
      //设置成 true 后，我们会自动给 a 标签绑定一个 sa.trackLink() 方法（详见本页 3.3 ），如果是单页面 a 标签不涉及页面跳转或者 a 标签的点击是下载功能，建议不要打开。默认 false 。
      loadTimeout:  1000,
      //设置多少毫秒后开始渲染点击图
      collect_url: function(){
          // 限制只采集微信端
          // && location.pathname.match(/^(\/)$|^(\/my\/?)$/g) !== null
          if (location.hostname === 'demo9527.flowerplus.cn' || location.hostname === 't.flowerplus.cn' || location.hostname === 'm.flowerplus.cn' || location.hostname === 'static2.flowerplus.cn') {
              return true;
          }
      }
      //返回true会采集当前页面的数据，返回false等假值表示不采集当前页面,设置这个函数后，内容为空的话，默认是返回假的。不写这个函数，默认是采集所有页面。
  }
  // ,
  // debug_mode:true
  ,
  debug_mode_upload:true
});



  param_data = {};

  
  
  
  
  
  sa.quick('autoTrackWithoutProfile', param_data);

</script>


<script type="text/javascript" src="js/fpa.channel.js?_t=20170907"></script>
<script>
var fp_utm_source = getQueryString('utm_source');
if (fp_utm_source != '' && fp_utm_source != null) {
    setCookie('fpa_channel_utm_source', fp_utm_source, null, '/', '.flowerplus.cn');
}
</script>

<script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?deb1341df19187ec5a232b519d62c8a9";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
</script>

<!--暂停google统计-->
<!-- 
<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
              ga('create', 'UA-93082500-1', 'auto');
              ga('send', 'pageview');
</script>
-->
<script>
    function exist_ga(){return typeof ga == 'function';}
    function ga_buy(){if(!exist_ga())return;ga("send",{hitType:"event",eventCategory:"订购流程",eventAction:"立即购买",eventLabel:"详情页购买"})}
    function ga_submit(){if(!exist_ga())return;ga("send",{hitType:"event",eventCategory:"订购流程",eventAction:"确认下单",eventLabel:"订单填写页"})}
    function ga_cancel(){if(!exist_ga())return;ga("send",{hitType:"event",eventCategory:"订购流程",eventAction:"取消订单",eventLabel:"订单确认页"})}
    function ga_pay(id,product_name,payment){if(!exist_ga())return;ga("send",{hitType:"event",eventCategory:"订购流程",eventAction:"去支付",eventLabel:"订单确认页"});ga("require","ecommerce");ga("ecommerce:addTransaction",{"id":id,"affiliation":product_name,"revenue":payment,});ga("ecommerce:send")};
</script>

        <script>
            var localIds = [],isMoved = false,isLoading = false,imgList = [];
            $('#chooseImgBtn').on('touchstart',function(){
                if(localIds.length >= 9){
                    FP.showError('最多只能选择9张图片哦')
                    return;
                }
                wx.ready(function(){
                    wx.chooseImage({
                        count: 9 - localIds.length,
                        sizeType: ['compressed'], // 可以指定是原图还是压缩图，默认二者都有
                        sourceType: ['album', 'camera'], // 可以指定来源是相册还是相机，默认二者都有
                        success: function (res) {
                            var str = '';
                            localIds = localIds.concat(res.localIds); // 返回选定照片的本地ID列表，localId可以作为img标签的src属性显示图片
                            $.each(res.localIds,function(i,item){
                                str += '<div class="imgBlock uploadImgItem fl rlt" data-src="'+item+'"><div class="imgWrap"><img src="'+item+'"></div><div class="icon closeBtn abs"></div></div>';
                            })
                            $('#chooseImgBtn').before(str);
                        },
                        fail: function(){
                            FP.showError('微信接口失效');
                        }
                    });
                })
            })
            $('#publishBtn').on('touchstart',function(){
                if(isLoading) return;
                var pub_txt = $.trim($('#publish_cont').val());
                if(pub_txt.length == 0 || localIds.length == 0){
                    FP.showError('请上传图片和文字');
                    return;
                }
                isLoading = true;
                FP.loading('正在发布...').show();
                wx.ready(function(){
                    var num = 0;
                    uploadImg(0); 
                    function uploadImg(i){
                        wx.uploadImage({
                            localId: localIds[i], // 需要上传的图片的本地ID，由chooseImage接口获得
                            isShowProgressTips: 0,// 默认为1，显示进度提示
                            success: function (res) {
                                imgList.push(res.serverId); // 返回图片的服务器端ID
                                num ++;
                                if(num < localIds.length){
                                    uploadImg(num);
                                }else{
                                    var data = {
                                        'content' : pub_txt,
                                        'upload_image' : imgList,
                                        'topic_id' : FP.getQueryString('id'),
                                    }
                                    FP.ajaxPost('/sns_wx/addPost',data,function(data){
                                        isLoading = false;
                                        FP.loading().hide();
                                        if(data.msg == 'success' && data.result){
                                            $('#publish_cont').val('');
                                            $('.uploadImgItem').remove();
                                            location.href = '/sns_wx/index';
                                        }
                                    },function(){
                                        FP.loading().hide();
                                        isLoading = false;
                                        FP.showError('网络不佳，稍后再试')
                                    })
                                }
                            },
                            fail:function(){
                                FP.loading().hide();
                                isLoading = false;
                                FP.showError("网络不佳，稍后再试。");
                            }
                        });
                    }
                })
            })
            $('.uploadImgBox').on('touchstart','.closeBtn',function(){
                if(isLoading) return;
                var deletItem = $(this).closest('.uploadImgItem').attr('data-src');
                $(this).closest('.uploadImgItem').remove();
                for(var i = 0; i < localIds.length; i++){
                    if(localIds[i] == deletItem){
                        localIds.splice(i,1);
                        break;
                    }
                }
            })
            $('.uploadImgBox').on('touchstart','.uploadImgItem img',function(e){
                isMoved = false;
            }).on('touchmove','.uploadImgItem img',function(){
                if(isMoved) return;
                isMoved = true;
            }).on('touchend','.uploadImgItem img',function(e){
                if(isMoved || isLoading) return;
                var src = $(this).attr('src');
                wx.previewImage({
                    current: src, // 当前显示图片的http链接
                    urls: localIds // 需要预览的图片http链接列表
                });
            })
        </script>
    </body>
</html>